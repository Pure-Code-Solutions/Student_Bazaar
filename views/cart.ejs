<!DOCTYPE html>
<html lang="en">
<%- include('./partials/navbar') %>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart | CampusShop</title>
    <link rel="stylesheet" href="styles/cart.css">
</head>
<body>

    
    <main class="cart-page">
        <div class="page-header">
            <h1>Your Cart</h1>
            <p>(<%= cart.reduce((total, item) => total + item.quantity, 0) %>) items in your cart</p>
        </div>
        
        <div class="cart-container">

            <div class="cart-items">
                <% cart.forEach(item => { %>
                    <!-- Cart item 1 -->
                <div class="cart-item">
                    <div class="item-image">
                        <img src="images/backpack.jpg" alt="Campus Backpack">
                    </div>
                    <div class="item-details">
                        <h3><a href="product-detail.html?id=102"><%= item.name %></a></h3>
                        <p class="item-variant"></p>
                        <div class="item-price">
                            <span class="current-price">$<%= item.price %></span>
                        </div>
                        <div class="item-actions">
                            <div class="quantity-selector">
                                <button class="qty-btn-minus" value="<%= item.itemID %>">-</button>
                                <!--input type="number" value="<%= item.quantity %>" min="1" max="10"-->
                                <span><%= item.quantity %></span>
                                <button class="qty-btn-plus" value="<%= item.itemID %>">+</button>
                            </div>
                            <button class="btn-remove" value="<%= item.itemID %>">Remove</button>
                            <button class="btn-save">Save for Later</button>
                        </div>
                    </div>
                </div>
                <% }); %>
                
              
            </div>
            
            <div class="cart-sidebar">
                <div class="order-summary">
                    <h2>Order Summary</h2>
                    <div class="summary-row">
                        <span>Subtotal ((<%= cart.reduce((total, item) => total + item.quantity, 0) %>) items)</span>
                        <span></span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span></span>
                    </div>
                    <div class="summary-row">
                        <span>Estimated Tax</span>
                        <span></span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span></span>
                    </div>
                    
                    <a href="checkout.html" class="btn-primary btn-checkout">Proceed to Checkout</a>
                    
                    <div class="promo-code">
                        <h3>Promo Code</h3>
                        <div class="promo-form">
                            <input type="text" placeholder="Enter promo code">
                            <button class="btn-apply">Apply</button>
                        </div>
                    </div>
                </div>
                
                <div class="continue-shopping">
                    <a href="/">Continue Shopping</a>
                </div>
            </div>
        </div>
        
        <!--div class="saved-items">
            <h2>Saved for Later</h2>
            <div class="saved-items-grid">

                <p class="empty-state">You don't have any saved items.</p>
            </div>
        </div>
        
        <div class="recommended-products">
            <h2>You Might Also Like</h2>
            <div class="products-row">

            </div>
        </div-->
    </main>
    
    <script>
        //Remove item from cart
        document.addEventListener("DOMContentLoaded", () => {
            const removeButtons = document.querySelectorAll(".btn-remove");
            //Handles when removed clicked
            removeButtons.forEach((btn) => {
                btn.addEventListener('click', async function() {
                    const itemID = btn.value;
  

                    try {
                        const response = await fetch("/cart", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ itemID: parseInt(itemID), removeItem: true}),
                        });

                        const result = await response.json();

                        if (response.ok) {
                            // Remove item from DOM without refreshing

                            await updateCartContent(response.text());
       
                        } 
                    } catch (error) {
                        console.error("Error:", error);
                    }
                });
            });

            //Handles when quantity is increment
            const plusButtons = document.querySelectorAll(".qty-btn-plus");
            plusButtons.forEach((btn) => {
                btn.addEventListener('click', async function() {
                    const itemID = btn.value;
       

                    try {
                        const response = await fetch("/cart", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ itemID: parseInt(itemID), incrementItem: true}),
                        });

                        console.log("Response HTML:", responseText);
                        const result = await response.json();
                        if (response.ok) {
                            await updateCartContent(response.text());
                            
                        } 
                    } catch (error) {
                        console.error("Error:", error);
                    }
                });
            });

             //Handles when quantity is decrement
           const minusButtons = document.querySelectorAll(".qty-btn-minus");
            minusButtons.forEach((btn) => {
                btn.addEventListener('click', async function() {
                    const itemID = btn.value;
                    try {
                        const response = await fetch("/cart", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ itemID: parseInt(itemID), decrementItem: true}),
                        });

             
                        const result = await response.json();
                        if (response.ok) {
                            
                            await updateCartContent(response.text());
                            
                        } 
                    } catch (error) {
                        console.error("Error:", error);
                    }
                });
            });


            //Not working idk ):
            async function updateCartContent(data) 
            {
                console.log("Updating cart content with data:", data);

                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = data;
                const newCartContent = tempDiv.querySelector(".cart-container");

                if (newCartContent) {
                    document.querySelector(".cart-container").innerHTML = newCartContent.innerHTML;
                } else {
                    console.error("Failed to find updated cart content in response");
                }
            }

            
        });





    </script>
    

</body>
</html>