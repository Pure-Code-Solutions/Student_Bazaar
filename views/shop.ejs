<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop | StudentStore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    
    <link rel="stylesheet" href="./styles/search.css">
    <%- include('./partials/navbar') %>
    <main>
        <div class="container">
                <div class="breadcrumb">
                    <a href="/">Home </a> &gt; <%= category %>
                </div>
   
        
 
            <section class="search-results-section">
                <div class="search-results-header">
                <!-- Updates when search box has entry-->
                <% if (false) { %>
                    <h1>Search Results</h1>
                    <p>Found 24 results</p>
                    
                <% } %>
                </div>

                <div class="search-filter-container">
                    <div class="search-filters">
                        <div class="filter-group">
                            <h3>Category</h3>
                            <ul>
                                <% subcategories.subcategories.forEach(sub => { %>
                                    <li>
                                        <input type="checkbox"
                                                name="subcategory"
                                                class="subcategory-checkbox" 
                                                value="<%= sub %>"
                                                >
                                        <label for="<%= sub %>"><%= sub %></label>
                                    </li>
                                <% }) %>
                            </ul>
                        </div>
                        <div class="filter-group">
                            <h3>Price Range</h3>
                            <ul>
                                <% prices.forEach(price => { %>
                                    <li>
                                        <input type="checkbox"
                                        name="price"
                                        class="price-checkbox" 
                                        value="<%= price.range %>">
                                        <label for="<%= price.range %>"><%= price.range %></label>
                                    </li>
                            <% }) %>
                            </ul>
                        </div>

                    </div>

                    <div class="search-results-content">
                        <div class="search-results-sorting">
                            <label for="sort-by">Sort by:</label>
                            <select id="sort-by">
                                <option value="relevance" selected>Relevance</option>
                                <option value="price-low">Price: Low to High</option>
                                <option value="price-high">Price: High to Low</option>
                                <option value="newest">Newest</option>
                                <option value="bestselling">Best Selling</option>
                            </select>
                            <div class="view-options">
                                <button class="view-grid active"><i class="fas fa-th"></i></button>
                                <button class="view-list"><i class="fas fa-list"></i></button>
                            </div>
                        </div>

                        <div class="search-results-grid">
                            <!-- Product Card 1 -->
                            <% products.forEach(product => { %> 
                                <div class="product-card">
                                    <div class="product-badge bestseller">Bestseller</div>
                                    <div class="product-image">
                                        <a href="product-detail.html?id=123">
                                            <img src="/api/placeholder/200/250" alt=<%= product.name %>>
                                        </a>
                                        <button class="quick-view-btn">Quick View</button>
                                    </div>
                                    <div class="product-info">
                                        <h3><a href="product-detail.html?id=123"><%= product.name %></a></h3>
                                        <div class="product-rating">
                                        <% for(var i= 1; i <= product.number_stars; i++) { %> 
                                            <i class="fas fa-star"></i>
                                        <% }; %>

                                            <!--i class="fas fa-star-half-alt"></i-->
                                        </div>
                                        <div class="product-price">
                                            <span class="current-price"><%= product.price %></span>
                                        </div>
                                        <div class="product-actions">
                                            <button class="add-to-cart-btn">Add to Cart</button>
                                            <button class="add-to-wishlist-btn"><i class="far fa-heart"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>


                        </div>
                        <div class="pagination">
                            <% if (page > 1) { %>
                                <a href="#" data-page="<%= page - 1 %>" class="page-link"> < </a>
                            <% } %>
                        
                            <% for (var i = 1; i <= numberOfPages; i++) { %> 
                                <a href="#" data-page="<%= i %>" class="page-link <%= i === page ? 'active' : '' %>"><%= i %> </a>
                            <% } %>
                        
                            <% if (page < numberOfPages) { %>
                                <a href="#" data-page="<%= page + 1 %>" class="page-link"> > </a>
                            <% } %>
                        </div>
                    </div>
                </div>
            </section>
            <% if (false) { %>
            <section class="related-searches">
                <h2>Related Searches</h2>
                <div class="related-search-tags">
                    <a href="search-results.html?query=programming+textbooks">Programming Textbooks</a>
                    <a href="search-results.html?query=computer+science+degree">Computer Science Degree</a>
                    <a href="search-results.html?query=coding+bootcamp">Coding Bootcamp</a>
                    <a href="search-results.html?query=python+books">Python Books</a>
                    <a href="search-results.html?query=algorithms">Algorithms</a>
                </div>
            </section>
            <%} %>
        </div>
    </main>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        
        async function fetchFilteredProducts(event, page = 1) {
            event?.preventDefault(); // Prevent default link behavior if event exists

                
            let currentPage = parseInt(page) || 1;

            let subcategories = Array.from(document.querySelectorAll(".subcategory-checkbox:checked"))
                .map(cb => cb.value); // Get selected subcategories

            let prices = Array.from(document.querySelectorAll(".price-checkbox:checked"))
                .map(cb => cb.value); // Get selected price ranges

            const pathParts = window.location.pathname.split("/"); 
            let category = pathParts.length > 2 ? pathParts[2] : ""; // Extracts category from URL

            let url = category ? `/shop/${category}` : `/shop`; // Base URL

            // Convert selected filters to comma-separated strings
            let selectedTags = subcategories.join("|");
            let selectedPrices = prices.join("|");

            // Construct query parameters
            let queryParams = new URLSearchParams();
            if (selectedTags) queryParams.set("tags", selectedTags);
            if (selectedPrices) queryParams.set("prices", selectedPrices);
            queryParams.set("page", currentPage);

            // Append query parameters
            url += `?${queryParams.toString()}`;

            // Update URL without reloading the page
            window.history.pushState({}, "", url);

            console.log("Fetching:", url); // Debugging


            try {
                const response = await fetch(url, {  
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                });
                const data = await response.text(); // Assuming the server returns HTML
               // ONLY Replaces the current search results with the new results and  without changing the entire page
               const tempDiv = document.createElement("div");
                tempDiv.innerHTML = data;
                const newSearchResults =  tempDiv.querySelector(".search-results-content");

                if (newSearchResults) {
                     document.querySelector(".search-results-content").innerHTML = newSearchResults.innerHTML;
                     attachPaginationListeners(); 
                }
                
            } catch (error) {
                console.error("Error fetching filtered products:", error);
            }

        }

            // Attach event listeners to checkboxes
            document.querySelectorAll(".subcategory-checkbox").forEach(checkbox => {
                checkbox.addEventListener("change", () => fetchFilteredProducts(null, 1)); // Reset to page 1 when filter changes
            });

            document.querySelectorAll(".price-checkbox").forEach(checkbox => {
                checkbox.addEventListener("change", () => fetchFilteredProducts(null, 1)); // Reset to page 1 when filter changes
            });

            attachPaginationListeners(); // Initial binding on page load

            // Handle Pagination Clicks
            function attachPaginationListeners() {
                document.querySelectorAll(".pagination a").forEach(link => {
                    link.addEventListener("click", function (event) {
                        event.preventDefault();
                        const page = this.getAttribute("data-page");
                        fetchFilteredProducts(event, page);
                    });
                });
            }
            // Preserve checkboxes state from URL on page load
            const params = new URLSearchParams(window.location.search);
            const selectedTags = params.get("tags") ? params.get("tags").split(",") : [];
            const selectedPrices = params.get("prices") ? params.get("prices").split(",") : [];
            document.querySelectorAll(".subcategory-checkbox").forEach(cb => {
                cb.checked = selectedTags.includes(cb.value);
            });
            document.querySelectorAll(".price-checkbox").forEach(cb => {
                cb.checked = selectedPrices.includes(cb.value);
            });
        });

       
    </script>
    

</body>
</html>