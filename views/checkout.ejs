<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | CampusShop</title>
    <link rel="stylesheet" href="css/checkout.css">
</head>
<body>
    <header class="checkout-header">
        <div class="logo">
            <a href="/"><img src="images/logo.svg" alt="CampusShop Logo"></a>
        </div>
        <div class="checkout-steps">
            <div class="step active">1. Shipping</div>
            <div class="step">2. Payment</div>
            <div class="step">3. Review</div>
        </div>
        <div class="secure-checkout">
            <img src="images/lock.svg" alt="Secure"> Secure Checkout
        </div>
    </header>
    
    <main class="checkout-page">
        <div class="checkout-container">
            <div class="checkout-main">
                <div class="checkout-section shipping-section active" id="shipping-section">
                    <h2>Shipping Information</h2>
                    
                    <div class="saved-addresses">
                        <h3>Saved Addresses</h3>
                        <div class="address-options">
                            <div class="address-card selected">
                                <div class="address-card-header">
                                    <span class="address-label">Home</span>
                                    <span class="address-default">Default</span>
                                </div>
                                <div class="address-card-body">
                                    <p>Jane Smith</p>
                                    <p><%= userAddress.street %>, <%= userAddress.premise %></p>
                                    <p><%= userAddress.city %>, <%= userAddress.state %>  <%= userAddress.postal_code %></p>
                                    <p><%= userAddress.country %></p>
                                </div>
                                <div class="address-card-actions">
                                    <a class ="edit-address-button" >Edit</a>
                                </div>
                            </div>
                            
                            <!--div class="address-card add-new">
                                <div class="add-new-content">
                                    <img src="images/plus.svg" alt="Add">
                                    <span>Add New Address</span>
                                </div>
                            </div-->
                        </div>
                    </div>
                    
                    <div class="shipping-options">
                        <h3>Shipping Method</h3>
                        <div class="shipping-option-list">
                            <label class="shipping-option">
                                <input type="radio" name="shipping" value="standard" checked>
                                <div class="shipping-option-info">
                                    <div class="shipping-name">Standard Shipping</div>
                                    <div class="shipping-estimate">3-5 business days</div>
                                </div>
                                <div class="shipping-price">FREE</div>
                            </label>
                            
                            <label class="shipping-option">
                                <input type="radio" name="shipping" value="expedited">
                                <div class="shipping-option-info">
                                    <div class="shipping-name">Expedited Shipping</div>
                                    <div class="shipping-estimate">2-3 business days</div>
                                </div>
                                <div class="shipping-price">$9.99</div>
                            </label>
                            
                            <label class="shipping-option">
                                <input type="radio" name="shipping" value="rush
                                <label class="shipping-option">
                                    <input type="radio" name="shipping" value="rush">
                                    <div class="shipping-option-info">
                                        <div class="shipping-name">Rush Shipping</div>
                                        <div class="shipping-estimate">1-2 business days</div>
                                    </div>
                                    <div class="shipping-price">$14.99</div>
                                </label>
                                
                                <label class="shipping-option">
                                    <input type="radio" name="shipping" value="campus">
                                    <div class="shipping-option-info">
                                        <div class="shipping-name">Campus Delivery</div>
                                        <div class="shipping-estimate">Delivery to campus mailroom</div>
                                    </div>
                                    <div class="shipping-price">FREE</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn-outline" onclick="window.location.href='/cart'">Return to Cart</button>
                            <button class="btn-primary" onclick="showSection('payment-section')">Continue to Payment</button>
                        </div>
                    </div>
                    
                    <div class="checkout-section payment-section" id="payment-section">
                        <h2>Payment</h2>
                        
                        <div class="payment-methods">
                            <h3>Payment Method</h3>
                            <div class="payment-tabs">
                                <button class="payment-tab active" data-method="card">Credit/Debit Card</button>
                                <button class="payment-tab" data-method="paypal">PayPal</button>
                                <button class="payment-tab" data-method="student-account">Student Account</button>
                            </div>
                            
                            <div class="payment-form card-form active">
                                <div class="form-row">
                                    <label for="card-number">Card Number</label>
                                    <input type="text" id="card-number" placeholder="1234 5678 9012 3456">
                                </div>
                                
                                <div class="form-row double">
                                    <div>
                                        <label for="card-expiry">Expiration Date</label>
                                        <input type="text" id="card-expiry" placeholder="MM/YY">
                                    </div>
                                    <div>
                                        <label for="card-cvv">Security Code</label>
                                        <input type="text" id="card-cvv" placeholder="CVV">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <label for="card-name">Name on Card</label>
                                    <input type="text" id="card-name" placeholder="John Doe">
                                </div>
                                
                                <div class="saved-payment">
                                    <input type="checkbox" id="save-payment">
                                    <label for="save-payment">Save this payment method for future orders</label>
                                </div>
                            </div>
                            
                            <div class="payment-form paypal-form">
                                <p>You will be redirected to PayPal to complete your payment.</p>
                                <button class="btn-paypal">Continue with PayPal</button>
                            </div>
                            
                            <div class="payment-form student-account-form">
                                <p>Charge this purchase to your Student Account.</p>
                                <div class="form-row">
                                    <label for="student-id">Student ID</label>
                                    <input type="text" id="student-id" placeholder="Enter your student ID">
                                </div>
                            </div>
                        </div>
                        
                        <div class="billing-address">
                            <h3>Billing Address</h3>
                            <div class="same-address">
                                <input type="checkbox" id="same-shipping" checked>
                                <label for="same-shipping">Same as shipping address</label>
                            </div>
                            <div class="billing-address-form" style="display: none;">
                                <!-- Billing address form fields would go here -->
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn-outline" onclick="showSection('shipping-section')">Back to Shipping</button>
                            <button class="btn-primary" onclick="showSection('review-section')">Continue to Review</button>
                        </div>
                    </div>
                    
                    <div class="checkout-section review-section" id="review-section">
                        <h2>Review Order</h2>
                        
                        <div class="review-sections">
                            <div class="review-section">
                                <div class="review-header">
                                    <h3>Shipping Information</h3>
                                    <a  onclick="showSection('shipping-section')">Edit</a>
                                </div>
                                <div class="review-content">
                                    <p>Jane Smith</p>
                                    <p><%= userAddress.street %>, <%= userAddress.premise %></p>
                                    <p><%= userAddress.city %>, <%= userAddress.state %>  <%= userAddress.postal_code %></p>
                                    <p><%= userAddress.country %></p>
                                    <p class="shipping-method">Standard Shipping (3-5 business days)</p>
                                </div>
                            </div>
                            
                            <div class="review-section">
                                <div class="review-header">
                                    <h3>Payment Method</h3>
                                    <a onclick="showSection('payment-section')">Edit</a>
                                </div>
                                <div class="review-content">
                                    <p><img src="images/visa.svg" alt="Visa"> ending in 3456</p>
                                    <p>Billing Address: Same as shipping</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="review-items">
                            <h3>Items</h3>
                            <div class="review-item-list">
                                <% cart.forEach(item => { %>
                                <div class="review-item">
                                
                                    <div class="item-image">
                                        <img src="images/backpack.jpg" alt="Campus Backpack">
                                    </div>
                                    <div class="item-details">
                                        <h4><%= item.name %></h4>
                                        <p>Qty: <%= item.quantity %></p>
                                    </div>
                                    <div class="item-price">$<%= item.price %></div>
                                </div>
                                
                                
                                <% }); %>
                            </div>
                            
                        </div>
                        <div class="form-actions">
                            <button class="btn-outline" onclick="showSection('payment-section')">Return to Payment</button>
                            <!--button class="btn-primary" onclick="window.location.href='cart'">Return to Cart </button-->
                        </div>
                        <div class="place-order">
                            <p class="terms-agreement">
                                <input type="checkbox" id="terms-agree" required>
                                <label for="terms-agree">I agree to the <a href="terms.html">Terms and Conditions</a> and <a href="privacy.html">Privacy Policy</a></label>
                            </p>
                            <form action = "" method = "POST">
                                <button class="btn-primary btn-place-order">Place Order</button>
                        </form>
                            <p class="order-disclaimer">You will not be charged until you place your order.</p>
                        </div>
                    </div>
                         
           
                </div>
                
                <div class="checkout-sidebar">
                    <div class="order-summary">
                        <h2>Order Summary</h2>
                        <div class="summary-items">
                            <div class="summary-row">
                                <span>Items ((<%= cart.reduce((total, item) => total + item.quantity, 0) %>))</span>
                                <span>$(X)</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping</span>
                            </div>
                            <div class="summary-row">
                                <span>Estimated Tax</span>
                                <span>$(X)</span>
                            </div>
                        </div>
                        <div class="summary-total">
                            <span>Order Total</span>
                            <span>$(X)</span>
                        </div>
                        
                        <div class="promo-section">
                            <button class="promo-toggle">Apply Promo Code</button>
                            <div class="promo-form" style="display: none;">
                                <input type="text" placeholder="Enter code">
                                <button>Apply</button>
                            </div>
                        </div>
                    </div>
             
                </div>
            </div>
        </main>
        
        <footer class="checkout-footer">
            <div class="footer-links">
                <a href="terms.html">Terms of Service</a>
                <a href="privacy.html">Privacy Policy</a>
                <a href="contact.html">Contact Us</a>
            </div>
            <div class="footer-secure">
                <img src="images/secure-payment.svg" alt="Secure Payment">
                <p>All transactions are secure and encrypted</p>
            </div>
            <div class="copyright">
                <p>&copy; 2025 CampusShop. All rights reserved.</p>
            </div>
        </footer>
        <dialog>
        <!---Dialog for when edit address button is clicked-->
        <div action="/checkout" class="address-dialog-box">
            <h3>Shipping Address</h3>
            <form method="POST">
            <div class="form-row">
              <div class="form-group">
                <label for="first-name" >First name</label>
                <input type="text" id="first-name" class="form-control" name="first-name" required>
              </div>
              <div class="form-group">
                <label for="last-name">Last name</label>
                <input type="text" id="last-name" class="form-control" name="last-name" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="address">Street</label>
              <input type="text" id="street" class="form-control" name="street" required>
            </div>
            
            <div class="form-group">
              <label for="apartment">Apartment, suite, etc.</label>
              <input type="text" id="apartment" class="form-control" name="premise" required>
            </div>
            
            <div class="form-group">
              <label for="city">City</label>
              <input type="text" id="city" class="form-control" name="city" required>
            </div>
            
            <div class="form-group">
              <label for="state">State/province</label>
              <select id="state" class="form-control" name="state" required>
                <option value="" selected disabled>Select state</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <!-- Add more states as needed -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="country">Country</label>
              <select id="country" class="form-control" name="country" required>
                <option value="US" selected>United States</option>
                <option value="CA">Canada</option>
                <!-- Add more countries as needed -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="zip">ZIP/postal code</label>
              <input type="text" id="zip" class="form-control" name="zip" required>
            </div>
            
            <div class="dialog-buttons">
              <button type="button" id="address-cancel-button" class="btn-secondary">Cancel</button>
              <button type="submit" id="address-submit-button" class="btn-primary">Save Address</button>
            </div>
          </div>
        </form>
        </dialog>
        <script>
          
                function showSection(sectionId) {
                    // Hide all sections
                    document.querySelectorAll('.checkout-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Show requested section
                    const section = document.getElementById(sectionId);
                    section.classList.add('active');
                    
                    // Update steps
                    const stepIndex = ['shipping-section', 'payment-section', 'review-section'].indexOf(sectionId);
                    document.querySelectorAll('.checkout-steps .step').forEach((step, index) => {
                        if (index <= stepIndex) {
                            step.classList.add('active');
                        } else {
                            step.classList.remove('active');
                        }
                    });

                    // Update browser history
                    let url = new URL(window.location);
                    url = `/checkout/${sectionId}`;
                    /*url.searchParams.set('section', sectionId);
                    window.history.pushState({ sectionId }, '', url)*/;
                    window.history.pushState({}, "", url);
                }

                // Handle browser navigation
                window.addEventListener('popstate', (event) => {
                    const sectionId = event.state && event.state.sectionId ? event.state.sectionId : 'shipping-section';
                    showSection(sectionId);
                });

                // Initialize section based on URL
                const initialSection = new URL(window.location).searchParams.get('section') || 'shipping-section';
                showSection(initialSection);
            
                const editButton = document.querySelector(".edit-address-button");
                const addressCancelButton = document.querySelector("#address-cancel-button");
                const submitAddressButton = document.querySelector("#address-submit-button");
                const dialog = document.querySelector("dialog");
                const addressForm = dialog.querySelector("form"); // Select the form inside the dialog
                 //Sets url if dialog for address is open


                //Show address dialog
                editButton.addEventListener("click", () => {
                    
                    // Update browser history
                    const url = new URL(window.location);
                    url.searchParams.set('editAddress', '1');
                    window.history.pushState({ editAddress: '1' }, '', url);
                    dialog.showModal();
                });
                //Hides address dialog
                addressCancelButton.addEventListener("click", () => {
                   // e.preventDefault(); // Prevent default behavior
                      // Removes editAddress on browser history
                    const url = new URL(window.location);
                    url.searchParams.delete('editAddress' , '1');
                    window.history.pushState({ editAddress: '1' }, '', url);
                    dialog.close();
                });

                //Hides dialog when new address submits
                submitAddressButton.addEventListener("click", async () => {
                   // e.preventDefault(); // Prevent default behavior
                    
                    if (addressForm.checkValidity()) {
                         // Removes editAddress on browser history
                         dialog.close();

                        const url = new URL(window.location);
                        url.searchParams.delete('editAddress');
                        window.history.pushState({}, '', url);

                        addressForm.submit(); // Submit the form if needed
                        
                         // Reload the page to reflect changes
                        /*setTimeout(function(){
                            window.location.reload();
                            });*/

                        //await updateAddressContent(data);

                    } else {
                        // If the form is invalid, trigger the browser's validation UI
                        addressForm.reportValidity();
                        
                    }
                        

                    
                });

   

            async function updateAddressContent(data) 
            {
                // ONLY Replaces the current search results with the new results and without changing the entire page
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = data;
                const newAddress = tempDiv.querySelector(".address-card-body");

                if (newAddress) {
                    document.querySelector(".address-card-body").innerHTML = newAddress.innerHTML;

                }
            }
        
            

                
        </script>
        <link rel="stylesheet" href="/styles/checkout.css">
    </body>
    </html>